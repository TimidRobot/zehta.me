<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"/><meta content="width=device-width, initial-scale=1" name="viewport"/><meta content="default-src 'self'; connect-src 'self' stats.zehta.me; font-src 'self' cdnjs.cloudflare.com; img-src 'self' licensebuttons.net www.gravatar.com; script-src 'self' stats.zehta.me; style-src 'self' cdnjs.cloudflare.com;" http-equiv="Content-Security-Policy"/><title>NVMEe on Debian on AWS - Timid Robot</title><meta content="Timid Robot Zehta" name="author"/><link href="/static/layout.css" integrity="sha512-rorP8qAZ973h10zwAm48StvvcfOMbJk7XQM0pOxxOsn73evY/105dw5e4GlE99VdrX0j6MTtVlR1bpCfmbNlsg==" rel="stylesheet"/><link crossorigin="anonymous" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/fontawesome.min.css" integrity="sha512-8Vtie9oRR62i7vkmVUISvuwOeipGv8Jd+Sur/ORKDD5JiLgTGeBSkI3ISOhc730VGvA5VVQPwKIKlmi+zMZ71w==" referrerpolicy="no-referrer" rel="stylesheet"/><link crossorigin="anonymous" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/brands.min.css" integrity="sha512-bSncow0ApIhONbz+pNI52n0trz5fMWbgteHsonaPk42JbunIeM9ee+zTYAUP1eLPky5wP0XZ7MSLAPxKkwnlzw==" referrerpolicy="no-referrer" rel="stylesheet"/><link crossorigin="anonymous" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/solid.min.css" integrity="sha512-6/gTF62BJ06BajySRzTm7i8N2ZZ6StspU9uVWDdoBiuuNu5rs1a8VwiJ7skCz2BcvhpipLKfFerXkuzs+npeKA==" referrerpolicy="no-referrer" rel="stylesheet"/><link href="/static/custom.css" integrity="sha512-StKCgZsirJcM+/mNn9aRCd8XW25qf0LbDkfjOCqEWM4QHbsTzf7p6RjqklHrq2hDldBVlz0zCpUh8XoAp3hYLg==" rel="stylesheet"/><link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png"/><link href="/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png"/><link href="/favicon-96x96.png" rel="icon" sizes="96x96" type="image/png"/><meta content="Timid Robot's website" property="og:site_name"/><meta content="https://zehta.me/" property="og:url"/><meta content="Blog" property="og:title"/><meta content="website" property="og:type"/><meta content="https://zehta.me/favicon-590x310.png" property="og:image"/><meta content="590" property="og:image:width"/><meta content="310" property="og:image:height"/><meta content="image/png" property="og:image:type"/><meta content="logo" property="og:image:alt"/></head><body><nav class="container"><div class="row"><div class="three columns title"><a href="/">Timid Robot</a></div><div class="nine columns navi"><div class="navgroup"><div class="linkinactive"><a class="linkinactive" href="/about/"><i class="fas fa-address-card"></i> About</a></div><div class="linkinactive"><a class="linkinactive" href="/resume/"><i class="fas fa-laptop-code"></i> Résumé</a></div></div><div class="navgroup"><div class="linkinactive"><a class="linkinactive" href="/tags/"><i class="fas fa-tags"></i> Tags</a></div><div class="linkactive"><a class="linkactive" href="/"><i class="fas fa-newspaper"></i> Blog</a></div></div></div></div></nav><main class="container page"><div class="row"><div class="blog-post"><h1>NVMEe on Debian on AWS</h1><div class="meta">2020 Apr 03, Timid Robot Zehta</div><h2 id="problem">Problem</h2><p>The current Creative Commons infrastructure buildouts use Debian GNU/Linux AWS EC2 instances with EBS volumes. Depending on chance (or race conditions), the mapping of block devices can be different from one host to another or between reboots.</p><blockquote><p><em>Occasionally, devices can respond to discovery in a different order in subsequent instance starts, which causes the device name to change.</em> (<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/nvme-ebs-volumes.html" title="Amazon EBS and NVMe on Linux Instances - Amazon Elastic Compute Cloud">Amazon EBS and NVMe on Linux Instances - Amazon Elastic Compute Cloud</a>)</p></blockquote><h2 id="our-solution">Our Solution</h2><p>Modern Amazon Linux AMIs resolve this by providing a <code>udev</code> rule, but Debian GNU/Linux does not yet do this. To ensure our systems are configured correctly, At Creative Commons, we use the device specified during provisioning (ex. <code>/dev/xvdf</code>) to identify the correct NVMEe device. We then format it with a label that can be used mounting during subsequent reboots.</p><p>Thankfully, AWS documents the the device specified during provisioning (ex. <code>/dev/xvdf</code>):</p><blockquote><p><em>For Nitro-based instances, the block device mappings that are specified in the Amazon EC2 console when you are attaching an EBS volume or during AttachVolume or RunInstances API calls are captured in the vendor-specific data field of the NVMe controller identification.</em> (<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/nvme-ebs-volumes.html" title="Amazon EBS and NVMe on Linux Instances - Amazon Elastic Compute Cloud">Amazon EBS and NVMe on Linux Instances - Amazon Elastic Compute Cloud</a>)</p></blockquote><p>We use SaltStack (<a href="https://github.com/creativecommons/sre-salt-prime" title="creativecommons/sre-salt-prime: Site Reliability Engineering / DevOps SaltStack configuration files"><code>creativecommons/sre-salt-prime</code></a>) to:</p><ol><li>Install the <code>nvme-cli</code> package</li><li>Use the <code>nvme</code> command to detect which <code>/dev/nvme?n?</code> contains <em>spec</em> (ex. <code>xvdf</code>) in the NVMe vendor specific data</li><li>Create a symlink (ex. <code>/dev/xvdf -&gt; /dev/nvme1n1</code>) so that SaltStack can use <code>/dev/xvdf</code> for the initial setup</li><li>Perform the intial setup</li><li>Delete the symlink since:<ol><li>The initial setup formatted the volume with a label that is used to mount the filesystem</li><li>There is no guarantee the symlink will be accurate on subsequent reboots and it might cause confusion</li></ol></li></ol><p>The <a href="https://github.com/creativecommons/sre-salt-prime/blob/master/states/mount/init.sls"><code>states/mount/init.sls</code></a> state includes a complex shell command (with Jinja2 variables) that loops through the NVMe devices and finds the correct one:</p><div class="hll"><pre><span></span><span class="k">for</span><span class="w"> </span>n<span class="w"> </span><span class="k">in</span><span class="w"> </span>/dev/nvme?n?
<span class="k">do</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span>nvme<span class="w"> </span>id-ctrl<span class="w"> </span>-v<span class="w"> </span><span class="si">${</span><span class="nv">n</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span><span class="s1">'^0000:.*{{ spec_short }}'</span>
<span class="w">    </span><span class="k">then</span>
<span class="w">        </span>ln<span class="w"> </span>-s<span class="w"> </span><span class="si">${</span><span class="nv">n</span><span class="si">}</span><span class="w"> </span><span class="o">{{</span><span class="w"> </span>spec_long<span class="w"> </span><span class="o">}}</span>
<span class="w">    </span><span class="k">fi</span>
<span class="k">done</span>
</pre></div><p>Example variable values:</p><table><thead><tr><th>Jinja2 Variable</th><th>Example Value</th></tr></thead><tbody><tr><td><code>{{ spec_short }}</code></td><td><code>xvdf</code></td></tr><tr><td><code>{{ spec_long }}</code></td><td><code>/dev/xvdf</code></td></tr></tbody></table><h3 id="related-links">Related Links</h3><ul><li><a href="https://wiki.debian.org/Cloud/AmazonEC2Image/Buster" title="Cloud/AmazonEC2Image/Buster - Debian Wiki">Cloud/AmazonEC2Image/Buster - Debian Wiki</a></li><li><a href="https://packages.debian.org/buster/nvme-cli" title="Debian -- Details of package nvme-cli in buster"><code>nvme-cli</code> package details in Debian buster</a></li><li>Debian buster — Debian Manpages<ul><li><a href="https://manpages.debian.org/buster/nvme-cli/nvme.1.en.html">nvme(1) — nvme-cli</a><ul><li><a href="https://manpages.debian.org/buster/nvme-cli/nvme-id-ctrl.1.en.html">nvme-id-ctrl(1) — nvme-cli</a></li></ul></li></ul></li></ul><h2 id="other-solutions">Other Solutions</h2><p>While doing additional research for this blog post, I found additional solutions to the same problem. They're all good, but I apprecite the simplicity of a temporary symlink for setup versus maintaining custom udev rules (maybe I can help contribute a udev based solution to Debian or Debian's EC2 image). I can also easily imagine a more complex solution being a better fit if/when our infrastructure provisioining become more complex.</p><ul><li><a href="https://github.com/oogali/ebs-automatic-nvme-mapping" title="oogali/ebs-automatic-nvme-mapping: Automatic mapping of EBS volumes via NVMe block devices to standard block device paths">oogali/ebs-automatic-nvme-mapping</a>: Automatic mapping of EBS volumes via NVMe block devices to standard block device paths<ul><li>udev rule that invokes a Bash script to create symlinks</li></ul></li><li>CoreOS<ul><li>udev rules that invokes a Bash script to create symlinks<ul><li><a href="https://github.com/coreos/init/blob/master/udev/rules.d/90-cloud-storage.rules"><code>udev/rules.d/90-cloud-storage.rules</code></a></li><li><a href="https://github.com/coreos/init/blob/master/udev/bin/cloud_aws_ebs_nvme_id"><code>udev/bin/cloud_aws_ebs_nvme_id</code></a></li></ul></li></ul></li><li><a href="https://gist.github.com/jalaziz/c22c8464cb602bc2b8d0a339b013a9c4">AWS EBS NVMe udev rules</a><ul><li>udev rule that invokes a Pyton script to create symlinks</li><li>this is a copy as Amazon only provides access to the source of Amazon Linux from within an Amazon Linux AMI: <em>The yumdownloader --source command line tool provided in the Amazon Linux AMI enables viewing of source code inside of an Amazon EC2.</em> (<a href="https://aws.amazon.com/amazon-linux-ami/faqs/" title="Amazon Linux AMI FAQs">Amazon Linux AMI FAQs</a>)</li></ul></li></ul><h2 id="originally-published">Originally Published</h2><p>Originally published <a href="https://opensource.creativecommons.org/blog/entries/2020-04-03-nvmee-on-debian-on-aws/" title="NVMEe on Debian on AWS — Creative Commons on GitHub">NVMEe on Debian on AWS — Creative Commons on GitHub</a>.</p><div><h2>Tags</h2><ul><li><a href="/tags/2020//"><i class="fas fa-tag"></i> 2020</a></li><li><a href="/tags/creative-commons//"><i class="fas fa-tag"></i> Creative Commons</a></li><li><a href="/tags/floss//"><i class="fas fa-tag"></i> Free/Libre and Open Source Software (FLOSS)</a></li><li><a href="/tags/saltstack//"><i class="fas fa-tag"></i> SaltStack</a></li></ul></div></div><hr class="copyright"/><p class="copyright"><a href="https://creativecommons.org/licenses/by/4.0/" rel="license" title="CC BY 4.0 (license button)"><img alt="CC BY 4.0 license button" src="https://licensebuttons.net/l/by/4.0/80x15.png#floatleft"/></a> Copyright © 2020 Creative Commons. This work is licensed under a <strong><a href="https://creativecommons.org/licenses/by/4.0/" rel="license" title="Creative Commons Attribution 4.0 International License">Creative Commons Attribution 4.0 International License</a>.</strong></p></div></main><nav class="container footer"><div class="post-prev"><a href="/2020/09/cleaning-cat-safe-plants/" title="Previous post: Air Cleaning and Cat Safe Plants"><i class="fas fa-angle-left"></i> Air Cleaning and Cat Safe P...</a></div><div class="post-next"><a href="/2019/12/recommending-a-policy/" title="Next post: Recommending a Friendly Space policy for Queering Wikipedia">Recommending a Friendly Spa... <i class="fas fa-angle-right"></i></a></div></nav><div class="container bottombot"><i class="fas fa-robot"></i></div><div class="none"><a href="https://hachyderm.io/@TimidRobot" rel="me">Mastodon</a></div></body></html>